set dotenv-load := true
set dotenv-filename := "ENV"


# Prepare S3 inputs + offline config (keeps repo light)
data:
    echo $PIPELINE

# Inspect created artifacts
check_data:
    @set -euo pipefail; \
    : "${PIPELINE:?set PIPELINE in ENV}"; \
    : "${S3_ROOT:?set S3_ROOT in ENV}"; \
    S3_PIPE_ROOT="${S3_ROOT}/${PIPELINE}"; \
    echo "== S3 path =="; echo "${S3_PIPE_ROOT}/data"; \
    echo "== S3 objects =="; aws s3 ls "${S3_PIPE_ROOT}/data" --recursive || true; \
    echo; echo "== local data/fastq_single.csv =="; test -f data/fastq_single.csv && cat data/fastq_single.csv || echo "missing"; \
    echo; echo "== remote fastq_single.csv =="; aws s3 cp "${S3_PIPE_ROOT}/data/fastq_single.csv" - || echo "missing on S3"

# Quick online run against offline config (uses Nexus proxy)
test:
    nextflow run . -profile test -resume -c <(echo 'docker { registry = "quay.io" }') -w /tmp/work-$PIPELINE 

# Quick online run with stub option
stub:
    nextflow run . -profile test -resume -c <(echo 'docker { registry = "quay.io" }') -w /tmp/work-$PIPELINE -stub

# Quick online run with preview option
preview:
    nextflow run . -profile test -resume -c <(echo 'docker { registry = "quay.io" }') -w /tmp/work-$PIPELINE -preview

# Push this repo to S3 (code only; exclude heavy dirs)
push:
    just clean
    aws s3 sync "${HOME}/offline/${PIPELINE}/${PIPELINE}" "${S3_ROOT}/${PIPELINE}/${PIPELINE}"  --exclude "work" --delete

# Pull mirror inside air-gapped VPC (offline side)
pull:
    just clean
    aws s3 sync "${S3_ROOT}/$PIPELINE/$PIPELINE" "${ROOT_DIR}/$PIPELINE/$PIPELINE"  --exclude "work" --delete

# Fully offline run
run:
    nextflow run . -profile test -offline -resume -w ${HOME}/work-$PIPELINE 

# Stub run
stub2:
    nextflow run . -profile test -offline -resume -w ${HOME}/work-$PIPELINE -stub

# Preview run
preview2:
    nextflow run . -profile test  -offline -resume -w ${HOME}/work-$PIPELINE -preview

# chmod +x -c /home/ssm-user/offline/rnaseq/rnaseq/bin/*
execpermission:
     chmod +x -c bin/*

# Convenience groups
online:
    just test push

offline:
    just pull run

# Local cleanup
clean:
    nextflow clean -f; rm -rf  /tmp/nxf-work/ .nextflow null
