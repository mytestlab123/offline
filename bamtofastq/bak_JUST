set dotenv-load := true          # ← **key line**
set dotenv-filename := ".env"    # (default, but explicit)

# 1. Download pipeline code (no container images)
pull:
    mkdir -p "$BUNDLE_DIR" && \
    nf-core pipelines download "$PIPELINE" \
        --revision "$REVISION" \
        --container-system none \
        --compress none \
        --outdir "$BUNDLE_DIR" --force

# 5. Mirror entire ~/offline → S3 (online side)
s3_push:
    rm -rf work null .nextflow
    aws s3 sync "${HOME}/offline/${PIPELINE}" "$S3_ROOT/${PIPELINE}"   --no-follow-symlinks --exclude "main"  --exclude ".nextflow/*" --delete

# 6. Pull mirror inside air-gapped VPC (offline side)
s3_pull:
    sudo rm -rf .nextflow/* /tmp/out* work null *.swp ".nextflow/" nxf-tmp*
    echo "ln -sv pipe/2_1_1 ${PIPELINE}"
    aws s3 sync  "$S3_ROOT/${PIPELINE}" "$ROOT_DIR/${PIPELINE}" --delete   --no-follow-symlinks --exclude "main"  --exclude ".nextflow/"

# 7. Run the pipeline fully offline
run:
    export NXF_OFFLINE=true && sudo -E nextflow -log /tmp/r run bamtofastq -profile off -c profile.conf -resume -offline --outdir /tmp/out-bamtofastq -w /tmp/work-bamtofastq --custom_config_base ''

